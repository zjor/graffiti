<!DOCTYPE html>
<html>
    <head>
        <style>
            html, div {
                margin: 0;
            }

            #container {
                width: 640px;
                margin: 0 auto;                
            }
            #message {
                text-align: center;
            }

        </style>
    <script src="https://code.jquery.com/jquery-3.4.0.min.js" crossorigin="anonymous"></script>
    </head>
<body>
    <div id="container">
        <h1 id="message"></h1>
        <div id="creator">
            <h3>Create message</h3>
            <textarea id="new-message"></textarea>
            <p id="encoded-message"></p>
            <a id="new-url" href="#"></a>
        </div>

    </div>
    <script>

        function b64EncodeUnicode(str) {
            // first we use encodeURIComponent to get percent-encoded UTF-8,
            // then we convert the percent encodings into raw bytes which
            // can be fed into btoa.
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function toSolidBytes(match, p1) {
                    return String.fromCharCode('0x' + p1);
            }));
        }

        function b64DecodeUnicode(str) {
            // Going backwards: from bytestream, to percent-encoding, to original string.
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }  

        const getMessage = () => {
            const url = new URL(window.location.href)
            return b64DecodeUnicode(url.searchParams.get("m"))
        }

        const buildUrl = (message) => {
            return window.location.origin + "?m=" + message
        }

        (function(){
            $("#message").text(getMessage())
            const encodedMessage = $("#encoded-message")
            const newUrl = $("#new-url")
            $("#new-message").on("change keyup paste", (e) => {
                const encoded = b64EncodeUnicode(e.target.value)
                const url = buildUrl(encoded)

                encodedMessage.text(encoded)                
                newUrl.text(url)
                newUrl.attr("href", url)
                });
        })();

    </script>
</body>
</html>